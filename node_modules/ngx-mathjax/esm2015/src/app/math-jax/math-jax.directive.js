import { Directive, ElementRef, Input, } from '@angular/core';
import { combineLatest, ReplaySubject, Subject, } from 'rxjs';
import { MathJaxService } from './math-jax.service';
import { map } from 'rxjs/operators';
/**
 * Typeset the content or expressions using MathJax library.
 */
export class MathJaxDirective {
    constructor(el, service) {
        /**
         * Observes the change of the input expression.
         */
        this.expressionChangeSubject = new ReplaySubject();
        /**
         * Observes the completion of the initial MathJax typesetting.
         */
        this.mathJaxTypesetSubject = new Subject();
        this.mathJaxHub$ = service.MathJaxHub$;
        this.element = el.nativeElement;
        this.typesetSubscription = combineLatest([
            this.mathJaxHub$,
            this.mathJaxTypesetSubject,
        ]).subscribe(() => {
            MathJax.Hub.Queue(['Typeset', MathJax.Hub, this.element]);
        });
        this.allJax$ = combineLatest([
            this.mathJaxHub$,
            this.mathJaxTypesetSubject,
        ]).pipe(map(() => MathJax.Hub.getAllJax(this.element)));
        this.expressionChangeSubscription = combineLatest([
            this.allJax$,
            this.expressionChangeSubject,
        ]).subscribe(([jax, updateValue]) => updateValue.forEach((v) => MathJax.Hub.Queue(() => {
            // Stop pushing messages to the queue when the component is being destroyed.
            if (!this.isDestroying) {
                return jax[v.order].Text(v.value);
            }
        })));
    }
    ngAfterViewInit() {
        this.hubSubscription = this.mathJaxHub$.subscribe(() => {
            MathJax.Hub.Queue(['Typeset', MathJax.Hub, this.element]);
            MathJax.Hub.Queue(['MathJaxTypeset', this]);
        });
    }
    /**
     * Explicitly trigger the MathJax typeset process.
     *
     * This is useful if the content is loaded dynamically.
     */
    MathJaxTypeset() {
        this.mathJaxTypesetSubject.next();
    }
    ngOnChanges(changes) {
        const expressions = changes.MathJaxExpressions;
        // Shortcut if there's nothing to update.
        if (!(expressions.currentValue instanceof Array)) {
            return;
        }
        // Update only the changed expressions.
        const updateValues = expressions.currentValue
            .map((cv, i) => (expressions.previousValue ? expressions.previousValue[i] !== cv : true)
            ? {
                value: expressions.currentValue[i],
                order: i,
            }
            : undefined)
            .filter((v) => v);
        this.expressionChangeSubject.next(updateValues);
    }
    ngOnDestroy() {
        this.isDestroying = true;
        this.expressionChangeSubscription.unsubscribe();
        this.hubSubscription.unsubscribe();
        this.typesetSubscription.unsubscribe();
        this.mathJaxTypesetSubject.complete();
        this.expressionChangeSubject.complete();
    }
}
MathJaxDirective.decorators = [
    { type: Directive, args: [{
                selector: 'mathjax, [mathjax]',
            },] }
];
MathJaxDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: MathJaxService }
];
MathJaxDirective.propDecorators = {
    MathJaxExpressions: [{ type: Input, args: ['mathjax',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aC1qYXguZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2FwcC9tYXRoLWpheC9tYXRoLWpheC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBS0EsT0FBTyxFQUVMLFNBQVMsRUFDVCxVQUFVLEVBQ1YsS0FBSyxHQUlOLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFDTCxhQUFhLEVBRWIsYUFBYSxFQUNiLE9BQU8sR0FFUixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckM7O0dBRUc7QUFJSCxNQUFNLE9BQU8sZ0JBQWdCO0lBNEIzQixZQUFZLEVBQWMsRUFBRSxPQUF1QjtRQWpCbkQ7O1dBRUc7UUFDSyw0QkFBdUIsR0FBRyxJQUFJLGFBQWEsRUFBeUIsQ0FBQztRQUM3RTs7V0FFRztRQUNjLDBCQUFxQixHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7UUFXMUQsSUFBSSxDQUFDLFdBQVcsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDLGFBQWEsQ0FBQztRQUVoQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsYUFBYSxDQUFDO1lBQ3ZDLElBQUksQ0FBQyxXQUFXO1lBQ2hCLElBQUksQ0FBQyxxQkFBcUI7U0FDM0IsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDaEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUM1RCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxPQUFPLEdBQUcsYUFBYSxDQUFDO1lBQzNCLElBQUksQ0FB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QUUsb0JBQW9CO2FBQy9COzs7WUFyQkMsVUFBVTtZQWFILGNBQWM7OztpQ0FhcEIsS0FBSyxTQUFDLFNBQVMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55ICovXG4vKipcbiAqIEBhdXRob3IgZGF2aWRzaGVuODRcbiAqL1xuaW1wb3J0IHsgVXBkYXRlVmFsdWUgfSBmcm9tICcuL2RvbWFpbi9pbnRlcmZhY2VzJztcbmltcG9ydCB7XG4gIEFmdGVyVmlld0luaXQsXG4gIERpcmVjdGl2ZSxcbiAgRWxlbWVudFJlZixcbiAgSW5wdXQsXG4gIE9uQ2hhbmdlcyxcbiAgT25EZXN0cm95LFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIGNvbWJpbmVMYXRlc3QsXG4gIE9ic2VydmFibGUsXG4gIFJlcGxheVN1YmplY3QsXG4gIFN1YmplY3QsXG4gIFN1YnNjcmlwdGlvbixcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBNYXRoSmF4U2VydmljZSB9IGZyb20gJy4vbWF0aC1qYXguc2VydmljZSc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbi8qKlxuICogVHlwZXNldCB0aGUgY29udGVudCBvciBleHByZXNzaW9ucyB1c2luZyBNYXRoSmF4IGxpYnJhcnkuXG4gKi9cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ21hdGhqYXgsIFttYXRoamF4XScsXG59KVxuZXhwb3J0IGNsYXNzIE1hdGhKYXhEaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XG4gIC8qKlxuICAgKiBBbiBhcnJheSBvZiBpbnB1dCBNYXRoSmF4IGV4cHJlc3Npb25zLlxuICAgKi9cbiAgQElucHV0KCdtYXRoamF4JylcbiAgcHVibGljIE1hdGhKYXhFeHByZXNzaW9uczogc3RyaW5nW107XG4gIHByaXZhdGUgcmVhZG9ubHkgbWF0aEpheEh1YiQ6IE9ic2VydmFibGU8YW55PjtcbiAgLyoqXG4gICAqIFRoZSBhc3NvY2lhdGVkIG5hdGl2ZSBlbGVtZW50LlxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBlbGVtZW50OiBIVE1MRWxlbWVudDtcbiAgLyoqXG4gICAqIE9ic2VydmVzIHRoZSBjaGFuZ2Ugb2YgdGhlIGlucHV0IGV4cHJlc3Npb24uXG4gICAqL1xuICBwcml2YXRlIGV4cHJlc3Npb25DaGFuZ2VTdWJqZWN0ID0gbmV3IFJlcGxheVN1YmplY3Q8VXBkYXRlVmFsdWU8c3RyaW5nPltdPigpO1xuICAvKipcbiAgICogT2JzZXJ2ZXMgdGhlIGNvbXBsZXRpb24gb2YgdGhlIGluaXRpYWwgTWF0aEpheCB0eXBlc2V0dGluZy5cbiAgICovXG4gIHByaXZhdGUgcmVhZG9ubHkgbWF0aEpheFR5cGVzZXRTdWJqZWN0ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICBwcml2YXRlIHJlYWRvbmx5IGV4cHJlc3Npb25DaGFuZ2VTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgLyoqXG4gICAqIE9ic2VydmUgdGhlIHJlYWRpbmVzcyBvZiBhbGwgdGhlIEpheCBpbnN0YW5jZXMgaW4gdGhlIGVsZW1lbnQuXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGFsbEpheCQ6IE9ic2VydmFibGU8YW55W10+O1xuICBwcml2YXRlIHJlYWRvbmx5IHR5cGVzZXRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBodWJTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBpc0Rlc3Ryb3lpbmc6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoZWw6IEVsZW1lbnRSZWYsIHNlcnZpY2U6IE1hdGhKYXhTZXJ2aWNlKSB7XG4gICAgdGhpcy5tYXRoSmF4SHViJCA9IHNlcnZpY2UuTWF0aEpheEh1YiQ7XG4gICAgdGhpcy5lbGVtZW50ID0gZWwubmF0aXZlRWxlbWVudDtcblxuICAgIHRoaXMudHlwZXNldFN1YnNjcmlwdGlvbiA9IGNvbWJpbmVMYXRlc3QoW1xuICAgICAgdGhpcy5tYXRoSmF4SHViJCxcbiAgICAgIHRoaXMubWF0aEpheFR5cGVzZXRTdWJqZWN0LFxuICAgIF0pLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICBNYXRoSmF4Lkh1Yi5RdWV1ZShbJ1R5cGVzZXQnLCBNYXRoSmF4Lkh1YiwgdGhpcy5lbGVtZW50XSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLmFsbEpheCQgPSBjb21iaW5lTGF0ZXN0KFtcbiAgICAgIHRoaXMubWF0aEpheEh1YiQsXG4gICAgICB0aGlzLm1hdGhKYXhUeXBlc2V0U3ViamVjdCxcbiAgICBdKS5waXBlKG1hcCgoKSA9PiBNYXRoSmF4Lkh1Yi5nZXRBbGxKYXgodGhpcy5lbGVtZW50KSkpO1xuXG4gICAgdGhpcy5leHByZXNzaW9uQ2hhbmdlU3Vic2NyaXB0aW9uID0gY29tYmluZUxhdGVzdChbXG4gICAgICB0aGlzLmFsbEpheCQsXG4gICAgICB0aGlzLmV4cHJlc3Npb25DaGFuZ2VTdWJqZWN0LFxuICAgIF0pLnN1YnNjcmliZSgoW2pheCwgdXBkYXRlVmFsdWVdKSA9PlxuICAgICAgdXBkYXRlVmFsdWUuZm9yRWFjaCgodikgPT5cbiAgICAgICAgTWF0aEpheC5IdWIuUXVldWUoKCkgPT4ge1xuICAgICAgICAgIC8vIFN0b3AgcHVzaGluZyBtZXNzYWdlcyB0byB0aGUgcXVldWUgd2hlbiB0aGUgY29tcG9uZW50IGlzIGJlaW5nIGRlc3Ryb3llZC5cbiAgICAgICAgICBpZiAoIXRoaXMuaXNEZXN0cm95aW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gamF4W3Yub3JkZXJdLlRleHQodi52YWx1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgdGhpcy5odWJTdWJzY3JpcHRpb24gPSB0aGlzLm1hdGhKYXhIdWIkLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICBNYXRoSmF4Lkh1Yi5RdWV1ZShbJ1R5cGVzZXQnLCBNYXRoSmF4Lkh1YiwgdGhpcy5lbGVtZW50XSk7XG4gICAgICBNYXRoSmF4Lkh1Yi5RdWV1ZShbJ01hdGhKYXhUeXBlc2V0JywgdGhpc10pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4cGxpY2l0bHkgdHJpZ2dlciB0aGUgTWF0aEpheCB0eXBlc2V0IHByb2Nlc3MuXG4gICAqXG4gICAqIFRoaXMgaXMgdXNlZnVsIGlmIHRoZSBjb250ZW50IGlzIGxvYWRlZCBkeW5hbWljYWxseS5cbiAgICovXG4gIE1hdGhKYXhUeXBlc2V0KCk6IHZvaWQge1xuICAgIHRoaXMubWF0aEpheFR5cGVzZXRTdWJqZWN0Lm5leHQoKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBjb25zdCBleHByZXNzaW9ucyA9IGNoYW5nZXMuTWF0aEpheEV4cHJlc3Npb25zO1xuXG4gICAgLy8gU2hvcnRjdXQgaWYgdGhlcmUncyBub3RoaW5nIHRvIHVwZGF0ZS5cbiAgICBpZiAoIShleHByZXNzaW9ucy5jdXJyZW50VmFsdWUgaW5zdGFuY2VvZiBBcnJheSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgb25seSB0aGUgY2hhbmdlZCBleHByZXNzaW9ucy5cbiAgICBjb25zdCB1cGRhdGVWYWx1ZXM6IFVwZGF0ZVZhbHVlPHN0cmluZz5bXSA9IGV4cHJlc3Npb25zLmN1cnJlbnRWYWx1ZVxuICAgICAgLm1hcCgoY3YsIGkpID0+XG4gICAgICAgIChleHByZXNzaW9ucy5wcmV2aW91c1ZhbHVlID8gZXhwcmVzc2lvbnMucHJldmlvdXNWYWx1ZVtpXSAhPT0gY3YgOiB0cnVlKVxuICAgICAgICAgID8ge1xuICAgICAgICAgICAgICB2YWx1ZTogZXhwcmVzc2lvbnMuY3VycmVudFZhbHVlW2ldLFxuICAgICAgICAgICAgICBvcmRlcjogaSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICA6IHVuZGVmaW5lZFxuICAgICAgKVxuICAgICAgLmZpbHRlcigodikgPT4gdik7XG4gICAgdGhpcy5leHByZXNzaW9uQ2hhbmdlU3ViamVjdC5uZXh0KHVwZGF0ZVZhbHVlcyk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmlzRGVzdHJveWluZyA9IHRydWU7XG5cbiAgICB0aGlzLmV4cHJlc3Npb25DaGFuZ2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLmh1YlN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIHRoaXMudHlwZXNldFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuXG4gICAgdGhpcy5tYXRoSmF4VHlwZXNldFN1YmplY3QuY29tcGxldGUoKTtcbiAgICB0aGlzLmV4cHJlc3Npb25DaGFuZ2VTdWJqZWN0LmNvbXBsZXRlKCk7XG4gIH1cbn1cbiJdfQ==